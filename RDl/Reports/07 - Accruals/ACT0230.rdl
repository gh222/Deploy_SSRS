<?xml version="1.0" encoding="utf-8"?>
<Report xmlns="http://schemas.microsoft.com/sqlserver/reporting/2008/01/reportdefinition" xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner">
  <Body>
    <ReportItems>
      <Tablix Name="table1">
        <TablixBody>
          <TablixColumns>
            <TablixColumn>
              <Width>1in</Width>
            </TablixColumn>
            <TablixColumn>
              <Width>1in</Width>
            </TablixColumn>
            <TablixColumn>
              <Width>1in</Width>
            </TablixColumn>
          </TablixColumns>
          <TablixRows>
            <TablixRow>
              <Height>0.25in</Height>
              <TablixCells>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="textbox5">
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>Contract ID</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                                <FontSize>11pt</FontSize>
                                <FontWeight>Bold</FontWeight>
                                <Color>White</Color>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style />
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>textbox5</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>LightGrey</Color>
                          <Style>Solid</Style>
                        </Border>
                        <BackgroundColor>SteelBlue</BackgroundColor>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                </TablixCell>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="textbox6">
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>Error </Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                                <FontSize>11pt</FontSize>
                                <FontWeight>Bold</FontWeight>
                                <Color>White</Color>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style />
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>textbox6</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>LightGrey</Color>
                          <Style>Solid</Style>
                        </Border>
                        <BackgroundColor>SteelBlue</BackgroundColor>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                </TablixCell>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="textbox7">
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>Description</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                                <FontSize>11pt</FontSize>
                                <FontWeight>Bold</FontWeight>
                                <Color>White</Color>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style />
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>textbox7</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>LightGrey</Color>
                          <Style>Solid</Style>
                        </Border>
                        <BackgroundColor>SteelBlue</BackgroundColor>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                </TablixCell>
              </TablixCells>
            </TablixRow>
            <TablixRow>
              <Height>0.21in</Height>
              <TablixCells>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="contract_id">
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>=Fields!contract_id.Value</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style />
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>contract_id</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>LightGrey</Color>
                          <Style>Solid</Style>
                        </Border>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                </TablixCell>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="error">
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>=Fields!error.Value</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style />
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>error</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>LightGrey</Color>
                          <Style>Solid</Style>
                        </Border>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                </TablixCell>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="notes">
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>=Fields!notes.Value</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style />
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>notes</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>LightGrey</Color>
                          <Style>Solid</Style>
                        </Border>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                </TablixCell>
              </TablixCells>
            </TablixRow>
          </TablixRows>
        </TablixBody>
        <TablixColumnHierarchy>
          <TablixMembers>
            <TablixMember />
            <TablixMember />
            <TablixMember />
          </TablixMembers>
        </TablixColumnHierarchy>
        <TablixRowHierarchy>
          <TablixMembers>
            <TablixMember>
              <KeepWithGroup>After</KeepWithGroup>
              <RepeatOnNewPage>true</RepeatOnNewPage>
              <KeepTogether>true</KeepTogether>
            </TablixMember>
            <TablixMember>
              <Group Name="table1_Details_Group">
                <DataElementName>Detail</DataElementName>
              </Group>
              <TablixMembers>
                <TablixMember />
              </TablixMembers>
              <DataElementName>Detail_Collection</DataElementName>
              <DataElementOutput>Output</DataElementOutput>
              <KeepTogether>true</KeepTogether>
            </TablixMember>
          </TablixMembers>
        </TablixRowHierarchy>
        <DataSetName>DataSet1</DataSetName>
        <Top>0.68in</Top>
        <Height>0.46in</Height>
        <Width>3in</Width>
        <Style />
      </Tablix>
      <Textbox Name="textbox1">
        <KeepTogether>true</KeepTogether>
        <Paragraphs>
          <Paragraph>
            <TextRuns>
              <TextRun>
                <Value>ACT0230 - </Value>
                <Style>
                  <FontFamily>Tahoma</FontFamily>
                  <FontSize>20pt</FontSize>
                  <FontWeight>Bold</FontWeight>
                  <Color>SteelBlue</Color>
                </Style>
              </TextRun>
              <TextRun>
                <Value>=iif(InStr(Globals!ReportServerUrl,"sqlreports2008-")&gt;0,"TEST","LIVE") &amp; " "</Value>
                <Style>
                  <FontFamily>Tahoma</FontFamily>
                  <FontSize>20pt</FontSize>
                  <FontWeight>Bold</FontWeight>
                  <Color>SteelBlue</Color>
                </Style>
              </TextRun>
              <TextRun>
                <Value>=Switch(
InStr(Globals!ReportFolder,"Multimedia") &gt; 0, "Multimedia"
,InStr(Globals!ReportFolder,"Music") &gt; 0, "Music"
,InStr(Globals!ReportFolder,"Video") &gt; 0, "Video"
,InStr(Globals!ReportFolder,"Books") &gt; 0, "Books"
,InStr(Globals!ReportFolder,"NewMedia") &gt; 0, "NewMedia"
,InStr(Globals!ReportFolder,"IPA") &gt; 0, "IPA"
,InStr(Globals!ReportFolder,"Audio") &gt; 0, "Audio"
,1=1, "Unknown Layer")
</Value>
                <Style>
                  <FontFamily>Tahoma</FontFamily>
                  <FontSize>20pt</FontSize>
                  <FontWeight>Bold</FontWeight>
                  <Color>SteelBlue</Color>
                </Style>
              </TextRun>
            </TextRuns>
            <Style />
          </Paragraph>
        </Paragraphs>
        <rd:DefaultName>textbox1</rd:DefaultName>
        <Height>0.36in</Height>
        <Width>8in</Width>
        <ZIndex>1</ZIndex>
        <Style>
          <PaddingLeft>2pt</PaddingLeft>
          <PaddingRight>2pt</PaddingRight>
          <PaddingTop>2pt</PaddingTop>
          <PaddingBottom>2pt</PaddingBottom>
        </Style>
      </Textbox>
      <Textbox Name="textbox2">
        <KeepTogether>true</KeepTogether>
        <Paragraphs>
          <Paragraph>
            <TextRuns>
              <TextRun>
                <Value>Contract Setup Exceptions</Value>
                <Style>
                  <FontFamily>Tahoma</FontFamily>
                  <FontSize>14pt</FontSize>
                  <FontWeight>Bold</FontWeight>
                  <Color>SteelBlue</Color>
                </Style>
              </TextRun>
            </TextRuns>
            <Style />
          </Paragraph>
        </Paragraphs>
        <rd:DefaultName>textbox2</rd:DefaultName>
        <Top>0.36in</Top>
        <Height>0.3in</Height>
        <Width>3in</Width>
        <ZIndex>2</ZIndex>
        <Style>
          <PaddingLeft>2pt</PaddingLeft>
          <PaddingRight>2pt</PaddingRight>
          <PaddingTop>2pt</PaddingTop>
          <PaddingBottom>2pt</PaddingBottom>
        </Style>
      </Textbox>
    </ReportItems>
    <Height>1.14in</Height>
    <Style />
  </Body>
  <Width>8.27083in</Width>
  <Page>
    <PageFooter>
      <Height>0.6in</Height>
      <PrintOnLastPage>true</PrintOnLastPage>
      <ReportItems>
        <Textbox Name="Textbox3">
          <KeepTogether>true</KeepTogether>
          <Paragraphs>
            <Paragraph>
              <TextRuns>
                <TextRun>
                  <Value>=Globals!ReportServerUrl</Value>
                  <Style />
                </TextRun>
                <TextRun>
                  <Value> Report Name: </Value>
                  <Style />
                </TextRun>
                <TextRun>
                  <Value>=Globals!ReportName</Value>
                  <Style />
                </TextRun>
                <TextRun>
                  <Value>, Time Stamp: </Value>
                  <Style />
                </TextRun>
                <TextRun>
                  <Value>=Globals!ExecutionTime</Value>
                  <Style />
                </TextRun>
                <TextRun>
                  <Value>, Run By: </Value>
                  <Style />
                </TextRun>
                <TextRun>
                  <Value>=User!UserID</Value>
                  <Style />
                </TextRun>
              </TextRuns>
              <Style />
            </Paragraph>
          </Paragraphs>
          <rd:DefaultName>Textbox3</rd:DefaultName>
          <Top>0.23556in</Top>
          <Height>0.25in</Height>
          <Width>8.27083in</Width>
          <Style>
            <Border>
              <Style>None</Style>
            </Border>
            <PaddingLeft>2pt</PaddingLeft>
            <PaddingRight>2pt</PaddingRight>
            <PaddingTop>2pt</PaddingTop>
            <PaddingBottom>2pt</PaddingBottom>
          </Style>
        </Textbox>
      </ReportItems>
      <Style>
        <Border>
          <Style>None</Style>
        </Border>
      </Style>
    </PageFooter>
    <PageHeight>8.5in</PageHeight>
    <PageWidth>15in</PageWidth>
    <LeftMargin>1in</LeftMargin>
    <RightMargin>1in</RightMargin>
    <TopMargin>1in</TopMargin>
    <BottomMargin>1in</BottomMargin>
    <Style />
  </Page>
  <Description>Contract Setup Exceptions</Description>
  <AutoRefresh>0</AutoRefresh>
  <DataSources>
    <DataSource Name="Temp_DataSource">
      <DataSourceReference>Temp_DataSource</DataSourceReference>
      <rd:SecurityType>None</rd:SecurityType>
      <rd:DataSourceID>56358e26-2626-43a3-950a-ca10d59afb0b</rd:DataSourceID>
    </DataSource>
  </DataSources>
  <DataSets>
    <DataSet Name="DataSet1">
      <Query>
        <DataSourceName>Temp_DataSource</DataSourceName>
        <CommandText>
DECLARE @Today dateTime
       ,@period_id id
       ,@rtn_code int

SELECT @rtn_code = 0 
SELECT @Today = GetDate() 
-- Get end date of current period - ignore some errors in future
SELECT @period_id = MIN(period_id) FROM x_period WHERE period_ending_date &gt;= @Today

IF OBJECT_ID('tempdb..#SetUpExceptions') IS NOT NULL DROP TABLE #SetUpExceptions
CREATE TABLE #SetUpExceptions
       (contract_sid int          NULL
       ,contract_id  nvarchar(255)           NULL
       ,error        VARCHAR(255) NULL
       ,notes        VARCHAR(255) NULL
	   ,status_sid int
	   )



-- Active Contracts should not have statement deal with complete status
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id 
      ,cs.status_id + ' Contract has statement deal with complete Status' AS 'Error'
      ,'Statement Deal Status is ' + cs.status_id + ', Contract Status is ' + cs.status_id + ', Start Period ' + xp.period_id  AS 'Notes'
	  ,cs.status_sid
FROM x_contract xc
INNER JOIN x_deal  xd
      ON xc.contract_sid = xd.contract_sid
      AND xd.deal_id LIKE '%STA%'
      AND xc.status_sid NOT IN (52,53)
INNER JOIN x_period xp
      ON xd.target_effective_period_sid = xp.period_sid
LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
WHERE xc.contract_sid = xc.original_contract_sid 
AND   xc.status_sid not in (6,16,18,30)
AND   xp.period_id &lt; @period_id
--  select * from c_status where status_id IN ('ARCHIVED', 'EXPIRED', 'MODEL','COMPLETE')


-- Statement deal should have statement approval group 
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
      ,'invalid approval group on statement deal' AS 'Error'
      ,'contract status ' + cs.status_id + ', deal_id ' + xd.deal_id + ', status ' + cs.status_id + ', approval group ' + cag.descr as 'Notes', cs.status_sid
FROM x_contract             xc
INNER JOIN x_deal          xd
      ON xc.contract_sid = xd.contract_sid
INNER JOIN c_approval_group cag
      ON xd.approval_group_sid = cag.approval_group_sid
	  LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
WHERE xc.contract_sid = xc.original_contract_sid
AND cs.status_id NOT IN ('ARCHIVED', 'EXPIRED')
AND cs.status_id     &lt;&gt; 'STOPPED' 
AND xd.deal_id like '%sta%'
AND xd.approval_group_sid &lt;&gt; 3 -- not statement approval group

--Accrual deals should have Accrual or Modelling Revision 39 approval group
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
      ,'invalid approval group on accrual deal' AS 'Error'
      ,'contract status ' + cs.status_id + ', deal_id ' + xd.deal_id + ', status ' + cs.status_id + ', approval group ' + cag.descr as 'Notes', cs.status_sid
FROM x_contract             xc
INNER JOIN x_deal          xd
      ON xc.contract_sid = xd.contract_sid
INNER JOIN c_approval_group cag
      ON xd.approval_group_sid = cag.approval_group_sid
	  LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
WHERE xc.contract_sid = xc.original_contract_sid
AND   cs.status_id NOT IN ('ARCHIVED', 'EXPIRED')
AND   cs.status_id     &lt;&gt; 'STOPPED' 
AND   xd.deal_id IN 
( ' MAIN ACCRUAL', 'ACCRUAL', 'ACCRUAL 1', 'ACCRUAL 2', 'ACCRUAL NEXT', 'ACCRUAL1'
 ,'ACCRUAL2', 'ACCURAL', 'ACHIVE ACCRUAL', 'ADJUST FINAL PAYMENT ACCRUAL'  ,'ADJUST FINAL PAYMENT ACCRUAL2'
 ,'ARCH AC MAIN','ARCH AC EQUITY/MU','ARCH AC NON-STD','ARCH AC OTHER','ARCHIVE ACCRUAL'
 ,'COPYRIGHT ACCRUAL' ,'EQUITY ACCRUAL','EQUITY/MU ACCRUAL','ISM ACCRUAL','NON-STD ACCRUAL'
 ,'OTHER ACCRUAL','OTHER ACCRUAL 2')
AND xd.approval_group_sid NOT IN (2,5) -- not accruals/Modeling Revision 39 Approved

-- Advance deal should have advance approval group 
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
      ,'invalid approval group on advance deal' AS 'Error'
      ,'contract status ' + cs.status_id + ', deal_id ' + xd.deal_id + ', status ' + cs.status_id + ', approval group ' + cag.descr as 'Notes', cs.status_sid
FROM x_contract             xc
INNER JOIN x_deal          xd
      ON xc.contract_sid = xd.contract_sid
INNER JOIN c_approval_group cag
      ON xd.approval_group_sid = cag.approval_group_sid
	  LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
WHERE xc.contract_sid = xc.original_contract_sid
AND   cs.status_id NOT IN ('ARCHIVED', 'EXPIRED')
AND   cs.status_id     &lt;&gt; 'STOPPED' 
AND   xd.deal_id like '%advance%'
AND   xd.approval_group_sid &lt;&gt; 1 -- not Advance Payment

--  Contracts should not have suspended scheduled statements
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
      ,'Contract status code ' + cs.status_id + ' and scheduled statement or calculation is suspended' AS 'Error'
      ,'Suspend Statement set to ' + xd.suspend_statements_flag  + ', Suspend calculation set to ' + xd.suspend_calculations_flag AS 'Notes'   , cs.status_sid
FROM x_contract xc
INNER JOIN x_deal xd 
      ON xc.contract_sid = xd.contract_sid
	  LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
WHERE xc.contract_sid = xc.original_contract_sid
AND   cs.status_id NOT IN ('ARCHIVED', 'EXPIRED')		
AND   ( xd.suspend_statements_flag = 'Y' OR  suspend_calculations_flag = 'Y')
AND   cs.status_id &lt;&gt; 'STOPPED'	

--  Statement Deals must have Statement Processing Type
DECLARE @udf_sid sid
SELECT @udf_sid = udf_sid FROM c_udf WHERE descr = 'Processing Type'

INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
      ,'statement deal does not have statement processing type' AS 'Error'
      ,'deal ' + xd.deal_id + ' with status ' + cs.status_id + ', processing type ' + xdu.udf_value AS 'Notes'  , cs.status_sid   
FROM x_contract xc 
INNER JOIN x_deal xd 
      ON xc.contract_sid =  xd.contract_sid
INNER JOIN x_deal_udf xdu
      ON xd.deal_sid = xdu.deal_sid 
	  LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
WHERE xc.contract_sid = xc.original_contract_sid
AND   xd.deal_id LIKE '%sta%'           -- Statement Deal
AND   xdu.udf_value NOT LIKE '%sta%'    -- Processing Type
AND   cs.status_id &lt;&gt; 'stopped'
AND   xdu.udf_sid = @udf_sid

--  Accrual Deal must have Accrual Processing Type 
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
      ,'accrual deal does not have accrual processing type' AS 'Error'
      ,'deal ' + xd.deal_id + ' with status ' + cs.status_id + ', processing type ' + xdu.udf_value AS 'Notes', cs.status_sid
FROM x_contract xc 
INNER JOIN x_deal xd 
      ON xc.contract_sid =  xd.contract_sid
INNER JOIN  x_deal_udf xdu
      ON xd.deal_sid = xdu.deal_sid 
	  LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
WHERE xc.contract_sid = xc.original_contract_sid
AND   xd.deal_id LIKE '%acc%'           -- Accrual Deal
AND   xdu.udf_value NOT LIKE '%acc%'    -- Processing Type
AND   cs.status_id &lt;&gt; 'stopped'
AND   xdu.udf_sid = @udf_sid

--  Contract must not have a stopped accrual with an active statement deal
--  Ignore Archive Accruals
--  Ignore Adjust Final Payment
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
      ,'has a stopped accrual with an active statement deal' AS Error
      ,xd_acc.deal_id + ' has status ' +  cs.status_id + ', ' + xd_stm.deal_id + ' has status ' + cs.status_id AS 'Notes', cs.status_sid
FROM  x_contract xc
LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
INNER JOIN x_deal xd_acc
      ON xc.contract_sid = xd_acc.contract_sid
      AND xd_acc.deal_id LIKE '%ACC%'
      AND xd_acc.deal_id NOT IN ( 'ACHIVE ACCRUAL','ARCH AC  MAIN','ARCH AC EQUITY/MU','ARCH AC NON-STD','ARCH AC OTHER','ARCHIVE ACCRUAL')
      AND cs.status_id = 'STOPPED'
INNER JOIN x_deal xd_stm
      ON xc.contract_sid = xd_stm.contract_sid
      AND xd_stm.deal_id LIKE '%STA%'
      AND xd_stm.deal_id NOT LIKE '%ADJUST FINAL PAYMENT%'
      AND cs.status_id &lt;&gt; 'STOPPED'

WHERE xc.contract_sid = xc.original_contract_sid
AND   cs.status_id NOT IN ('EXPIRED', 'ARCHIVED') 

--  Contract must not have active accrual with a stopped statement deal
--  Ignore Archive Accruals
--  Ignore Adjust Final Payment
INSERT INTO #SetUpExceptions (contract_sid,contract_id, error, notes,status_sid)
SELECT xc.contract_sid
      ,xc.contract_id      
     ,'has an active accrual with a stopped statement deal' AS Error
      ,xd_acc.deal_id + ' has status ' +  cs.status_id + ', ' + xd_stm.deal_id + ' has status ' + cs.status_id  AS 'Notes'
	  ,cs.status_sid
FROM  x_contract xc
LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
INNER JOIN x_deal xd_acc
      ON xc.contract_sid = xd_acc.contract_sid
      AND xd_acc.deal_id LIKE '%ACC%'
      AND xd_acc.deal_id NOT IN ('ACHIVE ACCRUAL','ARCH AC  MAIN','ARCH AC EQUITY/MU','ARCH AC NON-STD','ARCH AC OTHER','ARCHIVE ACCRUAL')
      AND cs.status_id &lt;&gt; 'STOPPED'
INNER JOIN x_deal xd_stm
      ON xc.contract_sid = xd_stm.contract_sid
      AND xd_stm.deal_id LIKE '%STA%'
      AND cs.status_id = 'STOPPED'
      AND xd_stm.deal_id NOT LIKE '%ADJUST FINAL PAYMENT ACCRUAL%'
WHERE xc.contract_sid = xc.original_contract_sid
AND   cs.status_id NOT IN ('EXPIRED', 'ARCHIVED') 

-- Delete contracts with an active accrual and 1 stopped statement deal which also has at least 1 other statement deals that is active
DELETE #SetUpExceptions
WHERE contract_id IN 
(SELECT xc.contract_id 
FROM #SetUpExceptions  xc
LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
INNER JOIN x_deal xd_stm
      ON xc.contract_sid = xd_stm.contract_sid
      AND xd_stm.deal_id LIKE '%STA%'
      AND cs.status_id &lt;&gt; 'STOPPED'  
WHERE xc.Error = 'has an active accrual with a stopped statement deal')
AND   Error = 'has an active accrual with a stopped statement deal'

-- Delete contracts with an active statement deal and 1 stopped accrual deal which also has at least 1 other accrual deals that is active
DELETE #SetUpExceptions
WHERE contract_id IN 
(SELECT  xc.contract_id  
FROM #SetUpExceptions  xc
LEFT JOIN c_status cs on cs.status_sid = xc.status_sid
INNER JOIN x_deal xd_acc
      ON xc.contract_sid = xd_acc.contract_sid
      AND xd_acc.deal_id LIKE '%AC%'
      AND cs.status_id &lt;&gt; 'STOPPED'  
WHERE xc.Error = 'has a stopped accrual with an active statement deal')
AND   Error = 'has a stopped accrual with an active statement deal'

SELECT contract_id, error, notes FROM  #SetUpExceptions ORDER BY contract_id
IF OBJECT_ID('tempdb..#SetUpExceptions') IS NOT NULL DROP TABLE #SetUpExceptions
</CommandText>
        <rd:UseGenericDesigner>true</rd:UseGenericDesigner>
      </Query>
      <Fields>
        <Field Name="contract_id">
          <DataField>contract_id</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="error">
          <DataField>error</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="notes">
          <DataField>notes</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
  </DataSets>
  <Language>en-GB</Language>
  <ConsumeContainerWhitespace>true</ConsumeContainerWhitespace>
  <rd:ReportUnitType>Inch</rd:ReportUnitType>
  <rd:ReportID>afecaac8-106e-4676-86ea-9adc07c1c8dc</rd:ReportID>
</Report>